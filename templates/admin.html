{% extends "base.html" %} {% block title %}Admin - DocSearch{% endblock %} {%
block content %}
<div x-data="adminApp()">
    <h1 class="text-2xl font-bold mb-6">Admin Dashboard</h1>

    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-5">
            <div class="text-3xl font-bold text-blue-600">
                {{ stats.document_count }}
            </div>
            <div class="text-gray-600 text-sm">Documents</div>
        </div>
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-5">
            <div class="text-3xl font-bold text-green-600">
                {{ stats.embedding_count }}
            </div>
            <div class="text-gray-600 text-sm">Embeddings</div>
        </div>
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-5">
            <div class="text-3xl font-bold text-purple-600">
                {{ stats.concept_count }}
            </div>
            <div class="text-gray-600 text-sm">Concepts</div>
        </div>
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-5">
            <div class="text-3xl font-bold text-orange-600">
                {{ stats.database_size_mb }}
            </div>
            <div class="text-gray-600 text-sm">Database (MB)</div>
        </div>
    </div>

    <!-- Last Sync -->
    <div class="text-sm text-gray-500 mb-6">
        Last sync: {{ stats.last_sync or 'Never' }}
    </div>

    <!-- Sync Section -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-8">
        <h2 class="text-lg font-semibold mb-4">Sync Documents</h2>

        <div class="flex gap-4 mb-4">
            <input
                type="text"
                x-model="syncFolder"
                placeholder="Documents folder path..."
                class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
            <button
                @click="startSync()"
                :disabled="syncing"
                class="px-6 py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 disabled:opacity-50"
            >
                <span x-show="!syncing">Start Sync</span>
                <span x-show="syncing">Syncing...</span>
            </button>
        </div>

        <!-- Progress -->
        <template x-if="syncStatus">
            <div class="mt-4">
                <div class="flex justify-between text-sm text-gray-600 mb-2">
                    <span
                        x-text="syncStatus.current_file || 'Starting...'"
                    ></span>
                    <span
                        x-text="syncStatus.processed + '/' + syncStatus.total"
                    ></span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2">
                    <div
                        class="bg-blue-600 h-2 rounded-full transition-all"
                        :style="'width: ' + (syncStatus.total ? (syncStatus.processed / syncStatus.total * 100) : 0) + '%'"
                    >
                    </div>
                </div>

                <template x-if="syncStatus.status === 'completed'">
                    <div
                        class="mt-4 p-4 bg-green-50 border border-green-200 rounded-lg"
                    >
                        <div class="font-medium text-green-800">
                            Sync Complete
                        </div>
                        <div class="text-sm text-green-700 mt-1">
                            Added: <span x-text="syncStatus.added"></span> •
                            Updated: <span x-text="syncStatus.updated"></span> •
                            Unchanged: <span
                                x-text="syncStatus.unchanged"
                            ></span>
                        </div>
                        <template x-if="syncStatus.errors.length > 0">
                            <div class="mt-2 text-sm text-red-600">
                                Errors: <span
                                    x-text="syncStatus.errors.length"
                                ></span>
                            </div>
                        </template>
                    </div>
                </template>
            </div>
        </template>
    </div>

    <!-- Concepts Section -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-8">
        <h2 class="text-lg font-semibold mb-4">Concept Vectors</h2>

        <!-- Create Concept Form -->
        <div class="flex gap-4 mb-4">
            <input
                type="text"
                x-model="newConcept.name"
                placeholder="Concept name..."
                class="w-48 px-4 py-2 border border-gray-300 rounded-lg"
            >
            <input
                type="text"
                x-model="newConcept.text"
                placeholder="Description text for embedding..."
                class="flex-1 px-4 py-2 border border-gray-300 rounded-lg"
            >
            <button
                @click="createConcept()"
                class="px-4 py-2 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700"
            >
                Create
            </button>
        </div>

        <!-- Concepts List -->
        <div class="space-y-2">
            {% for concept in concepts %}
            <div
                class="flex items-center justify-between p-3 bg-gray-50 rounded-lg"
            >
                <div>
                    <span class="font-medium">{{ concept.name }}</span>
                    <span class="text-gray-500 text-sm ml-2"
                    >{{ concept.source_text[:100] }}...</span>
                </div>
                <button
                    @click="deleteConcept('{{ concept.name }}')"
                    class="text-red-600 hover:text-red-800 text-sm"
                >
                    Delete
                </button>
            </div>
            {% else %}
            <div class="text-gray-500 text-sm">No concepts stored</div>
            {% endfor %}
        </div>
    </div>

    <!-- Documents Section -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <h2 class="text-lg font-semibold mb-4">Documents</h2>

        <div class="flex gap-4 mb-4">
            <input
                type="text"
                x-model="docSearch"
                @keyup.enter="loadDocuments()"
                placeholder="Search documents..."
                class="flex-1 px-4 py-2 border border-gray-300 rounded-lg"
            >
            <button
                @click="cleanupDeleted()"
                class="px-4 py-2 bg-gray-600 text-white rounded-lg font-medium hover:bg-gray-700"
            >
                Cleanup Deleted
            </button>
        </div>

        <!-- Documents Table -->
        <div class="overflow-x-auto">
            <table class="w-full text-sm">
                <thead>
                    <tr class="border-b border-gray-200">
                        <th class="text-left py-2 px-3">Title</th>
                        <th class="text-left py-2 px-3">Path</th>
                        <th class="text-left py-2 px-3">Words</th>
                        <th class="text-left py-2 px-3">Modified</th>
                        <th class="text-left py-2 px-3"></th>
                    </tr>
                </thead>
                <tbody>
                    <template x-for="doc in documents" :key="doc.id">
                        <tr class="border-b border-gray-100 hover:bg-gray-50">
                            <td
                                class="py-2 px-3 font-medium"
                                x-text="doc.title?.substring(0, 50)"
                            >
                            </td>
                            <td
                                class="py-2 px-3 text-gray-500 text-xs mono"
                                x-text="doc.filepath?.split('/').pop()"
                            >
                            </td>
                            <td class="py-2 px-3" x-text="doc.word_count"></td>
                            <td
                                class="py-2 px-3 text-gray-500"
                                x-text="doc.modified_at?.split('T')[0]"
                            >
                            </td>
                            <td class="py-2 px-3">
                                <button
                                    @click="deleteDocument(doc.id)"
                                    class="text-red-600 hover:text-red-800"
                                >
                                    Delete
                                </button>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        <div class="flex justify-between items-center mt-4">
            <span
                class="text-sm text-gray-500"
                x-text="'Page ' + docPage + ' of ' + docTotalPages"
            ></span>
            <div class="flex gap-2">
                <button
                    @click="docPage--; loadDocuments()"
                    :disabled="docPage <= 1"
                    class="px-3 py-1 border border-gray-300 rounded disabled:opacity-50"
                >
                    Prev
                </button>
                <button
                    @click="docPage++; loadDocuments()"
                    :disabled="docPage >= docTotalPages"
                    class="px-3 py-1 border border-gray-300 rounded disabled:opacity-50"
                >
                    Next
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %} {% block scripts %}
<script>
    function adminApp() {
        return {
            syncFolder: "./documents",
            syncing: false,
            syncStatus: null,
            syncTaskId: null,

            newConcept: { name: "", text: "" },

            documents: [],
            docSearch: "",
            docPage: 1,
            docTotalPages: 1,

            init() {
                this.loadDocuments();
            },

            async startSync() {
                this.syncing = true;
                this.syncStatus = null;

                try {
                    const res = await fetch("/admin/sync", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            folder: this.syncFolder,
                        }),
                    });

                    const data = await res.json();
                    if (data.error) {
                        alert(data.error);
                        this.syncing = false;
                        return;
                    }

                    this.syncTaskId = data.task_id;
                    this.pollSyncStatus();
                } catch (err) {
                    console.error(err);
                    this.syncing = false;
                }
            },

            async pollSyncStatus() {
                try {
                    const res = await fetch(
                        "/admin/sync/status/" + this.syncTaskId,
                    );
                    this.syncStatus = await res.json();

                    if (this.syncStatus.status === "running") {
                        setTimeout(() => this.pollSyncStatus(), 500);
                    } else {
                        this.syncing = false;
                        this.loadDocuments();
                    }
                } catch (err) {
                    console.error(err);
                    this.syncing = false;
                }
            },

            async createConcept() {
                if (!this.newConcept.name || !this.newConcept.text) {
                    return;
                }

                await fetch("/admin/concepts", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(this.newConcept),
                });

                this.newConcept = { name: "", text: "" };
                location.reload();
            },

            async deleteConcept(name) {
                if (!confirm("Delete concept: " + name + "?")) return;
                await fetch("/admin/concepts/" + name, {
                    method: "DELETE",
                });
                location.reload();
            },

            async loadDocuments() {
                const params = new URLSearchParams({
                    page: this.docPage,
                    search: this.docSearch,
                });

                const res = await fetch("/admin/documents?" + params);
                const data = await res.json();

                this.documents = data.documents;
                this.docTotalPages = data.pages || 1;
            },

            async deleteDocument(id) {
                if (!confirm("Delete this document?")) return;
                await fetch("/admin/documents/" + id, {
                    method: "DELETE",
                });
                this.loadDocuments();
            },

            async cleanupDeleted() {
                const res = await fetch("/admin/cleanup", {
                    method: "POST",
                });
                const data = await res.json();
                alert("Removed " + data.removed + " deleted documents");
                this.loadDocuments();
            },
        };
    }
</script>
{% endblock %}
